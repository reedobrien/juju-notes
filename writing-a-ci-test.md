# Writing a CI test for a juju core feature

## System info

	$ uname -a
		Linux erwin 4.4.0-16-generic #32-Ubuntu SMP Thu Mar 24 22:38:01 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux
	$ lsb_release -a
		No LSB modules are available.
		Distributor ID:	Ubuntu
		Description:	Ubuntu Xenial Xerus (development branch)
		Release:	16.04
		Codename:	xenial 
	$ go version
	    go version go1.6 linux/amd64 

## Install LXD

	$ sudo apt-get install lxd
		...
	$ newgrp lxd

lxd 2.0.0-rc8 removes dep on lxc1 and has a different install/config procedure. Maybe `lxc init` on clean install, or `dpkg reconfigure lxd` on an upgrade -- or wherever `lxd init` fails due to existing images/containers. What happens with other failures??? Also, figure out if we want or don't want an http proxy in lxd.

	$ sudo mkdir /var/lib/zfs
	$ sudo truncate -s 128G /var/lib/zfs/lxd.img
	$ sudo zpool create lxd /var/lib/zfs/lxd.img
	$ sudo zpool status

	$ sudo lxd start lxd.service # make sure it has started
	$ sudo lxd init --auto --storage-backend zfs --storage-pool lxd  

You may be able to configure during init but since I was already inited I used this:

	$ sudo dpkg-reconfigure lxd 
	
Fill in the answers so you get something like [the following](http://paste.ubuntu.com/15640296/):

		# WARNING: This file is generated by a debconf template!
		# It is recommended to update it by using "dpkg-reconfigure lxd"

		# Whether to setup a new bridge or use an existing one
		USE_LXD_BRIDGE="true"

		# Bridge name
		# This is still used even if USE_LXD_BRIDGE is set to false
		# set to an empty value to fully disable
		LXD_BRIDGE="lxdbr0"

		# Path to an extra dnsmasq configuration file
		LXD_CONFILE=""

		# DNS domain for the bridge
		LXD_DOMAIN="lxd"

		# IPv4
		## IPv4 address (e.g. 10.0.4.1)
		LXD_IPV4_ADDR="10.0.4.1"

		## IPv4 netmask (e.g. 255.255.255.0)
		LXD_IPV4_NETMASK="255.255.255.0"

		## IPv4 network (e.g. 10.0.4.0/24)
		LXD_IPV4_NETWORK="10.0.4.1/24"

		## IPv4 DHCP range (e.g. 10.0.4.2,10.0.4.254)
		LXD_IPV4_DHCP_RANGE="10.0.4.2,10.0.4.254"

		## IPv4 DHCP number of hosts (e.g. 250)
		LXD_IPV4_DHCP_MAX="253"

		## NAT IPv4 traffic
		LXD_IPV4_NAT="true"

		# IPv6
		## IPv6 address (e.g. 2001:470:b368:4242::1)
		LXD_IPV6_ADDR=""

		## IPv6 CIDR mask (e.g. 64)
		LXD_IPV6_MASK=""

		## IPv6 network (e.g. 2001:470:b368:4242::/64)
		LXD_IPV6_NETWORK=""

		## NAT IPv6 traffic
		LXD_IPV6_NAT="false"

		# Run a minimal HTTP PROXY server
		LXD_IPV6_PROXY="false"

Then we can test out lxd and make sure it is working without juju or just move on to the next section:)
	
	$ lxc launch ubuntu-daily:16.04 first  
	$ lxc exec apt update 
	  ## Should see the output from apt update.
	$ lxc stop first
	$ lxc delete first

## Build Juju

	$ sudo apt-get install juju-mongodb
	$ mkdir ~/juju
	$ gopath ~/juju
	$ export PATH=$PATH:$HOME/juju/bin
	$ mkdir juju/src/github.com/juju/juju
	$ cd  juju/src/github.com/juju/juju
	$ git clone git@github.com:juju/juju.git .
	$ go get ./...
	$ godeps -u depedencies.txt
	$ make
	$ go install ./...
	$ go test ./... TODO(ro) BTA duration too long. Only features that take longer than a test run become targets.


## Try it out

	$ export CONTROLLER_NAME=lxd-controller
	$ juju bootstrap $CONTROLLER_NAME lxd --upload-tools
	$ juju deploy mysql && juju deploy wordpress
	$ juju add-relation mysql wordpress
	$ juju expose wordpress
	$ juju status  ## note the wordpress IP
	$ xdg-open http://<wordpress_address>

Fill in the form and setup a blog... good enough if it worked. Destry it NOW,
before you update master and build a new juju, the new version cannot -- as of
this writing -- destroy a controller that was created by a preveious version. 

	$ juju destroy-controller --destroy-all-models -y $CONTROLLER_NAME


## Get ci tools and ci repository 

	$ cd ~/py
	$ bzr branch lp:juju-ci-tools/repository
	$ bzr branch lp:juju-ci-tools 
	$ cd juju-ci-tools

Other strange magic to use the CI test tools. TODO(ro) BTA WTF to get it setup.

	$ sudo apt-get install virtualenv python-pip python-setuptools
	$ virtualenv --system-site-packages juju-ci-tools
	$ pip install -r requirements.txt
	$ pip install pyyaml
	$ pip install boto
	$ pip install mock
	$ pip install python-jenkins
	$ pip install python-novaclient
	$ mkdir ~/.juju  # Sadly the CI Tools require this for 2.x tests too. Martin is aware, but ...
	$ vim ~/.juju/environments.yaml  
		environments:
			lxd:
				type: lxd
				# this makes the lxd provider skip apt-get upgrade
				# which is slow, particularly on a hotel network.
				enable-os-upgrade: false 
			aws:
				type: ec2
				enable-os-upgrade: false
				default-series: xenial
				region: us-west-1
				access-key: <KEY>
				secret-key: <KEY>
				
	# Load some aws creds in the environment
	$ source ~/.aws/ro  
	# This pulls the aws creds and write it to a creds file
	$ juju autoload-credentials  
	$ ln -s ~/.local/share/juju/credentials.yaml ~/.juju/  ## Link the creds file to the juju1 location for ci-tools
	$ touch ~/.juju/clouds.yaml  # ci-tools requires this file, even if empty.
	$ mkdir ~/tmp
	$ mkdir ~/tmp/juju-ci-tools  # ci-tools puts output here.

Next we need to make a test suite for ci-tools 

	$ make new-assess name=new_feature
		install -m 755 template_assess.py.tmpl assess_new_feature.py
		install -m 644 template_test.py.tmpl tests/test_assess_new_feature.py
		sed -i -e "s/TEMPLATE/new_feature/g" assess_new_feature.py tests/test_assess_new_feature.py

	$ # Edit edit edit
	$ rm -rf ~/tmp/juju-ci-tools/*  # Empty this NOW, so it doesn't bomb after a run and you don't get your logs you might want.
	$ export CONTROLLER_NAME=test-lxd-controller-name
	$ date && python assess_min_version.py --series xenial --debug lxd ~/juju/bin/juju ~/tmp/juju-ci-tools  --upload-tools $CONTROLLER_NAME   && echo "exit: $?"; date 	  
	$ Wait...



## Barriers to adoption

...
